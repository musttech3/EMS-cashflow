# نظام دعوات العائلات - Family Invitations API

## نظرة عامة
نظام دعوات العائلات يسمح لمشرفي العائلات بإرسال دعوات لمستخدمين معينين للانضمام لعائلاتهم. المستخدمون يمكنهم قبول أو رفض هذه الدعوات.

## الميزات الرئيسية
- ✅ إرسال دعوات من مشرف العائلة
- ✅ قبول/رفض الدعوات من المستخدمين
- ✅ تتبع حالة الدعوات (معلقة، مقبولة، مرفوضة، منتهية الصلاحية)
- ✅ كود دعوة فريد لكل دعوة
- ✅ رسالة مخصصة مع الدعوة
- ✅ صلاحية محدودة للدعوات (أسبوع واحد)
- ✅ إلغاء الدعوات من قبل المشرف

## نقاط النهاية (Endpoints)

### 1. إرسال دعوة عائلة
**POST** `/api/families/{familyId}/invitations`

**الوصف:** يرسل مشرف العائلة دعوة لمستخدم معين

**المعاملات:**
- `familyId` (path): معرف العائلة
- `inviteeUsername` (body): اسم المستخدم المراد دعوته
- `message` (body, optional): رسالة مخصصة مع الدعوة

**مثال الطلب:**
```json
{
    "inviteeUsername": "ahmed123",
    "message": "مرحباً! نود دعوتك للانضمام لعائلتنا"
}
```

**مثال الاستجابة:**
```json
{
    "id": 1,
    "inviterUsername": "admin_user",
    "inviteeUsername": "ahmed123",
    "familyName": "عائلة أحمد",
    "familyCode": "FAM123",
    "invitationCode": "ABC12345",
    "message": "مرحباً! نود دعوتك للانضمام لعائلتنا",
    "status": "PENDING",
    "createdAt": "2024-01-15T10:30:00",
    "expiresAt": "2024-01-22T10:30:00",
    "respondedAt": null
}
```

### 2. قبول دعوة عائلة
**POST** `/api/invitations/{invitationCode}/accept`

**الوصف:** يقبل المستخدم دعوة الانضمام للعائلة

**المعاملات:**
- `invitationCode` (path): كود الدعوة

**مثال الاستجابة:**
```json
"Successfully joined the family: عائلة أحمد"
```

### 3. رفض دعوة عائلة
**POST** `/api/invitations/{invitationCode}/reject`

**الوصف:** يرفض المستخدم دعوة الانضمام للعائلة

**المعاملات:**
- `invitationCode` (path): كود الدعوة

**مثال الاستجابة:**
```json
"Invitation rejected successfully"
```

### 4. عرض الدعوات المعلقة
**GET** `/api/invitations/pending`

**الوصف:** يعرض جميع الدعوات المعلقة للمستخدم الحالي

**مثال الاستجابة:**
```json
[
    {
        "id": 1,
        "inviterUsername": "admin_user",
        "inviteeUsername": "ahmed123",
        "familyName": "عائلة أحمد",
        "familyCode": "FAM123",
        "invitationCode": "ABC12345",
        "message": "مرحباً! نود دعوتك للانضمام لعائلتنا",
        "status": "PENDING",
        "createdAt": "2024-01-15T10:30:00",
        "expiresAt": "2024-01-22T10:30:00",
        "respondedAt": null
    }
]
```

### 5. عرض دعوات العائلة
**GET** `/api/families/{familyId}/invitations`

**الوصف:** يعرض جميع دعوات العائلة (للمشرف فقط)

**المعاملات:**
- `familyId` (path): معرف العائلة

### 6. إلغاء دعوة
**DELETE** `/api/invitations/{invitationId}`

**الوصف:** يلغي مشرف العائلة دعوة معلقة

**المعاملات:**
- `invitationId` (path): معرف الدعوة

## حالات الدعوات (Invitation Status)

- **PENDING**: دعوة معلقة (لم يتم الرد عليها بعد)
- **ACCEPTED**: دعوة مقبولة
- **REJECTED**: دعوة مرفوضة
- **EXPIRED**: دعوة منتهية الصلاحية

## قواعد الأمان

1. **فقط مشرف العائلة** يمكنه إرسال دعوات
2. **فقط المدعو** يمكنه قبول أو رفض الدعوة
3. **الدعوات صالحة لمدة أسبوع واحد** فقط
4. **لا يمكن إرسال دعوة لنفس المستخدم والعائلة** إذا كانت هناك دعوة معلقة
5. **لا يمكن إرسال دعوة لعضو موجود** في العائلة بالفعل

## رموز الخطأ

| الكود | الوصف |
|-------|--------|
| `INVITATION_NOT_FOUND` | الدعوة غير موجودة |
| `INVITATION_EXPIRED` | الدعوة منتهية الصلاحية |
| `INVITATION_ALREADY_EXISTS` | دعوة معلقة موجودة بالفعل |
| `NOT_FAMILY_ADMIN` | المستخدم ليس مشرف العائلة |
| `USER_NOT_FOUND` | المستخدم غير موجود |
| `FAMILY_NOT_FOUND` | العائلة غير موجودة |
| `RELATIONSHIP_EXISTS` | المستخدم عضو في العائلة بالفعل |

## مثال على سير العمل

1. **مشرف العائلة** يرسل دعوة لمستخدم معين
2. **المستخدم** يتلقى الدعوة في قائمة الدعوات المعلقة
3. **المستخدم** يختار قبول أو رفض الدعوة
4. **إذا قبل:** يتم إضافته للعائلة تلقائياً
5. **إذا رفض:** يتم تحديث حالة الدعوة إلى "مرفوضة"

## ملاحظات مهمة

- جميع الطلبات تتطلب مصادقة JWT
- الدعوات تتنظف تلقائياً عند انتهاء صلاحيتها
- يمكن للمشرف إلغاء الدعوات المعلقة في أي وقت
- كود الدعوة فريد ومكون من 8 أحرف 